name: Update Windsurf package

on:
  schedule:
    - cron: '0 */8 * * *'
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  update:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Update package files
        shell: pwsh
        run: |
          ./scripts/update.ps1

      - name: Check for changes
        id: changes
        shell: pwsh
        run: |
          if (git status --porcelain) {
            "changed=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          } else {
            "changed=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          }

      - name: Commit changes
        if: steps.changes.outputs.changed == 'true'
        run: |
          git add -A
          git commit -m "Update Windsurf package"
          git pull --rebase
          git push

      - name: Build package
        if: steps.changes.outputs.changed == 'true'
        shell: pwsh
        run: |
          $nuspec = Get-ChildItem -Filter "windsurf.*.nuspec" | Select-Object -First 1
          if (-not $nuspec) { throw "No nuspec found to pack." }
          choco pack $nuspec.FullName

      - name: Push package
        if: steps.changes.outputs.changed == 'true'
        shell: pwsh
        env:
          CHOCOLATEY_API_KEY: ${{ secrets.CHOCOLATEY_API_KEY }}
        run: |
          if (-not $env:CHOCOLATEY_API_KEY) { throw "CHOCOLATEY_API_KEY is not set." }
          $nuspec = Get-ChildItem -Filter "windsurf.*.nuspec" | Select-Object -First 1
          if (-not $nuspec) { throw "No nuspec found to read version." }
          [xml]$nuspecXml = Get-Content -Path $nuspec.FullName
          $packageId = $nuspecXml.package.metadata.id
          $packageVersion = $nuspecXml.package.metadata.version
          if (-not $packageId -or -not $packageVersion) {
            throw "Package id/version missing from nuspec."
          }
          $pkg = Get-ChildItem -Filter "windsurf.*.nupkg" | Sort-Object LastWriteTime -Descending | Select-Object -First 1
          if (-not $pkg) { throw "No nupkg found to push." }
          $pushOutput = choco push $pkg.FullName --source https://push.chocolatey.org/ --api-key $env:CHOCOLATEY_API_KEY 2>&1
          if ($LASTEXITCODE -ne 0) {
            if ($pushOutput -match 'already exists on the repository') {
              Write-Host "Package $packageId $packageVersion already exists. Skipping push."
              exit 0
            }
            throw "choco push failed: $pushOutput"
          }
